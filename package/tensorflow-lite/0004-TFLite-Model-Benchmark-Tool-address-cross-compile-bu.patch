From c4d331a3c279cdfdaa4c23500475cc634b3e98b8 Mon Sep 17 00:00:00 2001
From: "Robert B. Calhoun" <rcalhoun@shotspotter.com>
Date: Wed, 18 Jun 2025 15:19:58 +0000
Subject: [PATCH 4/4] TFLite Model Benchmark Tool: address cross-compile build
 issues

Add user option to control build of the model benchmarking tool. Defaults
to ON to maintain existing behavior. When enabled, add an explicit dependency
on protobuf to facilitate cross-compiled builds.
---
 tensorflow/lite/CMakeLists.txt                 | 9 ++++++++-
 tensorflow/lite/tools/benchmark/CMakeLists.txt | 8 +++++++-
 2 files changed, 15 insertions(+), 2 deletions(-)

diff --git a/tensorflow/lite/CMakeLists.txt b/tensorflow/lite/CMakeLists.txt
index bce9627fbd3..767c7d3f223 100644
--- a/tensorflow/lite/CMakeLists.txt
+++ b/tensorflow/lite/CMakeLists.txt
@@ -76,6 +76,7 @@ option(TFLITE_ENABLE_XNNPACK "Enable XNNPACK backend" ON)
 option(TFLITE_ENABLE_EXTERNAL_DELEGATE "Enable External Delegate backend" ON)
 
 option(TFLITE_KERNEL_TEST "Enable tflite kernel unit test" OFF)
+option(TFLITE_BENCHMARK_MODEL "Enable TFLite Model Benchmark Tool" ON)
 
 if(${CMAKE_CROSSCOMPILING})
   set(TFLITE_HOST_TOOLS_DIR "" CACHE PATH "Host tools directory")
@@ -175,6 +176,10 @@ if (NOT CMAKE_SYSTEM_PROCESSOR OR CMAKE_SYSTEM_PROCESSOR MATCHES "x86")
 endif()
 find_package(cpuinfo REQUIRED)  #CPUINFO is used by XNNPACK and RUY library
 find_package(ml_dtypes REQUIRED)
+if(TFLITE_BENCHMARK_MODEL)
+  find_package(protobuf REQUIRED)
+endif()
+
 find_package(ruy REQUIRED)
 # Include TSL, which is in tensorflow/third_party
 include_directories(
@@ -790,7 +795,9 @@ add_subdirectory(${TFLITE_SOURCE_DIR}/profiling/proto)
 add_subdirectory(${TF_SOURCE_DIR}/core/example ${CMAKE_BINARY_DIR}/example_proto_generated)
 
 # The benchmark tool.
-add_subdirectory(${TFLITE_SOURCE_DIR}/tools/benchmark)
+if(TFLITE_BENCHMARK_MODEL)
+  add_subdirectory(${TFLITE_SOURCE_DIR}/tools/benchmark)
+endif()
 
 # The label_image example.
 add_subdirectory(${TFLITE_SOURCE_DIR}/examples/label_image)
diff --git a/tensorflow/lite/tools/benchmark/CMakeLists.txt b/tensorflow/lite/tools/benchmark/CMakeLists.txt
index 477254a42ec..7418449076f 100644
--- a/tensorflow/lite/tools/benchmark/CMakeLists.txt
+++ b/tensorflow/lite/tools/benchmark/CMakeLists.txt
@@ -51,9 +51,15 @@ list(APPEND TFLITE_BENCHMARK_LIBS
   feature_proto
   example_proto
   model_runtime_info_proto
-  protobuf::libprotobuf
 )
 
+if(TARGET protobuf::libprotobuf)
+  list(APPEND TFLITE_BENCHMARK_LIBS protobuf::libprotobuf)
+else()
+  list(APPEND TFLITE_BENCHMARK_LIBS ${PROTOBUF_LIBRARIES})
+endif()
+
+
 # TODO(b/171007016): Enable performance options on Windows.
 if(NOT "${CMAKE_SYSTEM_NAME}" STREQUAL "Windows")
   list(APPEND TFLITE_BENCHMARK_SRCS
-- 
2.43.0

